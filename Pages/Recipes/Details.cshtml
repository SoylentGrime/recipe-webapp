@page "{id:int}"
@model Recipe_Webpage.Pages.Recipes.DetailsModel
@inject Recipe_Webpage.Services.ILocalizationService L
@{
    var culture = L.CurrentCulture;
    var title = Model.Recipe?.GetTitle(culture) ?? L["ViewRecipe"];
    var description = Model.Recipe?.GetDescription(culture);
    var ingredients = Model.Recipe?.GetIngredients(culture) ?? "";
    var instructions = Model.Recipe?.GetInstructions(culture) ?? "";
    var category = Model.Recipe?.GetCategory(culture);
    ViewData["Title"] = title;
}

@if (Model.Recipe == null)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> @L["RecipeNotFound"]
    </div>
    <a asp-page="Index" class="btn btn-primary">@L["BackToRecipes"]</a>
}
else
{
    <div class="container">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-page="Index">@L["Recipes"]</a></li>
                @if (!string.IsNullOrEmpty(category))
                {
                    <li class="breadcrumb-item"><a asp-page="Index" asp-route-category="@Model.Recipe.Category">@category</a></li>
                }
                <li class="breadcrumb-item active" aria-current="page">@title</li>
            </ol>
        </nav>

        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    @if (!string.IsNullOrEmpty(Model.Recipe.ImageUrl))
                    {
                        <img src="@Model.Recipe.ImageUrl" class="card-img-top" alt="@title" style="max-height: 400px; object-fit: cover;">
                    }
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h1 class="card-title">@title</h1>
                                @if (!string.IsNullOrEmpty(category))
                                {
                                    <span class="badge bg-info fs-6">@category</span>
                                }
                            </div>
                            <div class="btn-group edit-mode-only" style="display: none;">
                                <a asp-page="Admin/Edit" asp-route-id="@Model.Recipe.Id" class="btn btn-outline-primary">
                                    <i class="bi bi-pencil"></i> @L["Edit"]
                                </a>
                                <a asp-page="Admin/Delete" asp-route-id="@Model.Recipe.Id" class="btn btn-outline-danger">
                                    <i class="bi bi-trash"></i> @L["Delete"]
                                </a>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(description))
                        {
                            <p class="lead">@description</p>
                        }
                    </div>
                </div>

                <!-- Ingredients -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="bi bi-basket"></i> @L["Ingredients"]</h4>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            @foreach (var ingredient in ingredients.Split('\n', StringSplitOptions.RemoveEmptyEntries))
                            {
                                <li class="list-group-item">
                                    <i class="bi bi-check2-circle text-success me-2"></i> @ingredient.Trim()
                                </li>
                            }
                        </ul>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-list-ol"></i> @L["Instructions"]</h4>
                    </div>
                    <div class="card-body">
                        <ol class="instruction-list">
                            @foreach (var step in instructions.Split('\n', StringSplitOptions.RemoveEmptyEntries))
                            {
                                var cleanStep = step.Trim();
                                // Remove leading number and period if present
                                if (cleanStep.Length > 2 && char.IsDigit(cleanStep[0]) && cleanStep[1] == '.')
                                {
                                    cleanStep = cleanStep.Substring(2).Trim();
                                }
                                <li class="mb-3">@cleanStep</li>
                            }
                        </ol>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Recipe Info Card -->
                <div class="card mb-4 sticky-top" style="top: 20px;">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Recipe Info</h5>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-hourglass-split text-primary"></i> @L["PrepTime"]</span>
                            <strong>@Model.Recipe.PrepTimeMinutes @L["min"]</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-fire text-danger"></i> @L["CookTime"]</span>
                            <strong>@Model.Recipe.CookTimeMinutes @L["min"]</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-clock text-success"></i> @L["TotalTime"]</span>
                            <strong>@(Model.Recipe.PrepTimeMinutes + Model.Recipe.CookTimeMinutes) @L["min"]</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="bi bi-people text-info"></i> @L["Servings"]</span>
                            <strong>@Model.Recipe.Servings</strong>
                        </li>
                    </ul>
                    <div class="card-footer text-muted small">
                        <div>Added: @Model.Recipe.CreatedAt.ToString("MMMM d, yyyy")</div>
                        @if (Model.Recipe.UpdatedAt.HasValue)
                        {
                            <div>Updated: @Model.Recipe.UpdatedAt.Value.ToString("MMMM d, yyyy")</div>
                        }
                    </div>
                </div>

                <!-- Print Button -->
                <button onclick="window.print()" class="btn btn-outline-secondary w-100 mb-4">
                    <i class="bi bi-printer"></i> @L["Print"]
                </button>

                <a asp-page="Index" class="btn btn-primary w-100">
                    <i class="bi bi-arrow-left"></i> @L["BackToRecipes"]
                </a>
            </div>
        </div>
    </div>

    <style>
        .instruction-list li {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        @@media print {
            .btn, nav, .sticky-top {
                display: none !important;
            }
        }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('editMode') === 'true') {
                document.querySelectorAll('.edit-mode-only').forEach(el => el.style.display = '');
            }
        });
    </script>
}
